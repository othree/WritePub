(function(){var a={};$.extend(a,{options:{defaults:{crumbs:{mainpage:{title:"main page"},introduction:{title:"introduction"}},booksPath:"books",fileExt:"html"}},meta:{toolbar:{read:{title:"read"},zoom:{title:"zoom"},download:{title:"download"},about:{title:"about"}},frontMatter:{introduction:{title:"introduction"},cover:{title:"cover"},titlepage:{title:"title page"},copyrightpage:{title:"copyright page"},authorspreface:{title:"author's preface"}}},book:{meta:{id:0,title:_("New Book"),creator:_("Hancorck"),
description:_("Book Description"),publisher:"",language:"",rights:"",toc:{ch1:{title:"Chapter 1"}}}}});$.extend(a,{init:function(b){if(a.inited)return false;a.inited=true;a.setOptions(b);a.options.mode=document.location.protocol=="file:"?"w":"r";a.options.path=document.location.pathname.replace(/[^\/]*$/,"");a.loadMeta();a.ui.init();a.presentId=a.getInitId();a.load(a.presentId)},setOptions:function(b){var c;for(c in a.options.defaults)a.options[c]=a.options.defaults[c];for(c in b)a.options[c]=b[c]},
getInitId:function(){return document.location.hash||"introduction"},safeId:function(b){return b.replace(/[^\w\d-_%]/g,"")},idExist:function(b){b=a.safeId(b);if(b.match(/^ch\d(-\d)*$/)||b.indexOf("http")===0||b=="mainpage")return b;else{for(var c in a.meta.frontMatter)if(c==b)return b;return false}},genId:function(b){var c=b.lastIndexOf("/")+1,e=b.lastIndexOf(".");b=b.substring(c,e);return a.idExist(a.safeId(b))},genFilePath:function(b){return b.indexOf(".")===-1?a.options.booksPath+"/"+a.book.meta.id+
"/"+b+"."+a.options.fileExt:a.options.booksPath+"/"+a.book.meta.id+"/"+b},load:function(b){b=a.idExist(a.safeId(b));if(b!==false){a.setContent(a.loadContent(b));var c={mainpage:{title:"main page",value:a.book.meta.mainPage}};c[b]=b.match(/^ch\d+(-\d+)*$/)?{title:a.book.meta.toc[b].title}:{title:a.meta.frontMatter[b].title};a.ui.breadcrumbs(c)}},save:function(b){b=a.idExist(a.safeId(b));b!==false&&a.saveContent(b,a.getContent(b))},loadMeta:function(){var b=a.genFilePath("meta.json");b=a.loadFile(b);
if(b!==false){b=JSON.parse(b);$.extend(a.book.meta,b)}},saveMeta:function(){var b=JSON.stringify(a.book.meta),c=a.genFilePath("meta.json");a.saveFile(c,b)},loadContent:function(b){b=a.genFilePath(b);b=a.loadFile(b);return b=b===false?"["+_("No contents")+"]":b},saveContent:function(b,c){b=a.genFilePath(b);return a.saveFile(b,c)},setContent:function(b){if(typeof b=="string"){a.editor.setContent(b);return true}else return false},getContent:function(){return a.editor.getContent()},saveFile:function(b,
c){return a.options.mode=="w"?saveFile(b,c):false},loadFile:function(b){var c=document.location.protocol+"//"+document.location.host+a.options.path+b;if(a.options.mode=="w")return loadFile(b);else{b=$.ajax({url:c,async:false});return b.status==200?b.responseText:false}},inited:false});$.extend(a,{editor:{load:function(){if(a.editor.inited)return false;$("#editor").tinymce({script_url:"writepub/vendor/tinymce/jscripts/tiny_mce/tiny_mce.js",theme:"advanced",width:"100%",height:"475",plugins:"safari,spellchecker,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",
theme_advanced_buttons1:"save,newdocument,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,styleselect,formatselect,fontselect,fontsizeselect",theme_advanced_buttons2:"cut,copy,paste,pastetext,pasteword,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,cleanup,help,code,|,insertdate,inserttime,preview,|,forecolor,backcolor",theme_advanced_buttons3:"tablecontrols,|,hr,removeformat,visualaid,|,sub,sup,|,charmap,emotions,iespell,media,advhr,|,print,|,ltr,rtl,|,fullscreen",
theme_advanced_buttons4:"insertlayer,moveforward,movebackward,absolute,|,styleprops,spellchecker,|,cite,abbr,acronym,del,ins,attribs,|,visualchars,nonbreaking,template,blockquote,pagebreak,|,insertfile,insertimage",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resizing:false,oninit:function(b){a.editor._instance=b;a.editor.inited=true}})},setContent:function(b){if(typeof b!="string")return false;a.editor.inited?
a.editor._instance.setContent(b):setTimeout(function(){a.editor.setContent(b)},100)},getContent:function(){if(!a.editor.inited)return false;return a.editor._instance.getContent()},inited:false,_instance:null}});$.extend(a,{ui:{init:function(){if(!a.inited||a.ui.inited)return false;a.ui.inited=true;var b=$("#container");if(b.length===0){$("body").append($('<div id="container"></div>'));b=$("#container")}b.html(a.ui.initTemplate);a.ui.updateHeader();a.ui.toolbar(a.meta.toolbar);a.ui.frontMatter();a.ui.breadcrumbs(a.options.defaults.crumbs);
a.editor.load();a.ui.tocEvent();a.ui.goContentEvent();$("#backto-main").parent().hide()},updateHeader:function(){$("#header h1").html(a.book.meta.title);$("#description").html(a.book.meta.description);$("#creator").html(a.book.meta.creator)},breadcrumbs:function(b){if(!a.ui.inited)return false;$("#breadcrumbs").empty();a.ui.fillList($("#breadcrumbs"),b)},toolbar:function(b){if(!a.ui.inited)return false;a.ui.fillList($("#toolbar"),b)},frontMatter:function(){if(!a.ui.inited)return false;a.ui.fillList($("#toc"),
a.meta.frontMatter)},toc:function(){if(!a.ui.inited)return false;a.ui.fillList($("#toc"),a.book.meta.toc)},tocEvent:function(){$("#toc").click(function(b){var c=$(b.target).attr("href");c=a.genId(c);if(c!==false){a.load(c);b.stopPropagation();b.preventDefault();return false}})},goContentEvent:function(){if(!a.ui.inited)return false;$("#goto-content").click(function(b){a.ui.toc();$("#goto-content").parent().hide();$("#backto-main").parent().show();a.load("ch1");b.stopPropagation();b.preventDefault();
return false});$("#backto-main").click(function(b){a.ui.frontMatter();$("#goto-content").parent().show();$("#backto-main").parent().hide();a.load("introduction");b.stopPropagation();b.preventDefault();return false})},fillList:function(b,c){if(!a.ui.inited)return false;var e="";for(var d in c){d=a.idExist(a.safeId(d));if(d!==false)e+='<li><a href="'+a.genFilePath(d)+'">'+_(c[d].title)+"</a></li>"}b.html(e)},getBody:function(){return $("body")},initTemplate:'<div id="header">    <h1></h1>    <p><span id="description"></span> by <span id="creator"></span></p></div><div id="nav">    <ol id="breadcrumbs"></ol>    <ul id="toolbar"></ul>    <div id="progress"></div></div><div id="main">    <div id="menu">        <p><a id="backto-main" href="">'+
_("back to main")+'</a></p>        <ol id="toc"></ol>        <p><a id="goto-content" href="">'+_("goto content")+'</a></p>    </div>    <div id="content">        <textarea id="editor"></textarea>    </div></div>',inited:false}});$(a.init);window.writepub=a})();
